name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Test Python bindings (${{ matrix.os }}, ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # x86_64 builds
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.10"
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.11"
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.12"
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.13"
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.14"
          # macOS x86_64 - Python 3.10 has dependency issues on macOS runners
          - os: macos-latest
            arch: x86_64
            python-version: "3.11"
          - os: macos-latest
            arch: x86_64
            python-version: "3.12"
          - os: macos-latest
            arch: x86_64
            python-version: "3.13"
          - os: macos-latest
            arch: x86_64
            python-version: "3.14"
          - os: windows-latest
            arch: x86_64
            python-version: "3.10"
          - os: windows-latest
            arch: x86_64
            python-version: "3.11"
          - os: windows-latest
            arch: x86_64
            python-version: "3.12"
          - os: windows-latest
            arch: x86_64
            python-version: "3.13"
          - os: windows-latest
            arch: x86_64
            python-version: "3.14"
          # arm64 builds (macOS uses native runners)
          - os: macos-latest
            arch: arm64
            python-version: "3.10"
          - os: macos-latest
            arch: arm64
            python-version: "3.11"
          - os: macos-latest
            arch: arm64
            python-version: "3.12"
          - os: macos-latest
            arch: arm64
            python-version: "3.13"
          - os: macos-latest
            arch: arm64
            python-version: "3.14"
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: ${{ matrix.arch == 'arm64' && 'arm64' || 'x64' }}
      
      - name: Build and test Python package
        run: |
          cd rustychickpeas-python
          python -m venv .venv
          if [ "${{ runner.os }}" == "Windows" ]; then
            source .venv/Scripts/activate
          else
            source .venv/bin/activate
          fi
          python -m pip install --upgrade pip
          python -m pip install maturin pytest pyarrow
          maturin develop --release
          python -c "import rustychickpeas; print('Package installed:', rustychickpeas.__file__)"
          pytest tests/ -v
        env:
          # PyO3 0.20.3 doesn't officially support Python 3.13/3.14 yet, use stable ABI
          PYO3_USE_ABI3_FORWARD_COMPATIBILITY: ${{ (matrix.python-version == '3.13' || matrix.python-version == '3.14') && '1' || '' }}
        shell: bash

  rust-tests:
    name: Test Rust core
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Run Rust tests
        run: |
          cargo test --workspace --release

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin
      
      - name: Run Rust coverage
        run: |
          mkdir -p coverage/rust
          cd rustychickpeas-core
          # cargo-tarpaulin --out Lcov creates lcov.info in the workspace root
          # Use --root to set the base path for relative file paths in LCOV
          # Use --package to only test rustychickpeas-core (exclude Python bindings which need Python)
          cargo tarpaulin \
            --package rustychickpeas-core \
            --exclude-files '*/tests/*' \
            --exclude-files '*/benches/*' \
            --exclude-files '*/target/*' \
            --exclude-files '*/examples/*' \
            --out Lcov \
            --root .. \
            --timeout 300
          # Move lcov.info from workspace root to coverage/rust/
          cd ..
          if [ -f lcov.info ]; then
            # Filter out any non-LCOV lines (log output, etc.) and ensure clean LCOV format
            grep -E '^(SF:|TN:|FNF:|FNH:|FNDA:|DA:|LF:|LH:|BRDA:|BRF:|BRH:|end_of_record)' lcov.info > coverage/rust/lcov.info || mv lcov.info coverage/rust/lcov.info
            echo "✓ Created lcov.info at coverage/rust/lcov.info"
            ls -lh coverage/rust/lcov.info
            # Verify it contains valid LCOV format
            if grep -q "^SF:" coverage/rust/lcov.info; then
              echo "✓ Valid LCOV file with $(grep -c '^SF:' coverage/rust/lcov.info) source files"
              echo "Sample file paths:"
              grep "^SF:" coverage/rust/lcov.info | head -3
            else
              echo "⚠ WARNING: File exists but may not be valid LCOV format"
            fi
          else
            echo "✗ ERROR: lcov.info not found in workspace root"
            echo "Current directory: $(pwd)"
            echo "Files in workspace root:"
            ls -la *.info 2>/dev/null || echo "No .info files found"
            exit 1
          fi
      
      - name: Verify Rust coverage file exists
        run: |
          # Verify from workspace root
          if [ -f coverage/rust/lcov.info ]; then
            echo "✓ Found lcov.info at coverage/rust/lcov.info"
            ls -lh coverage/rust/lcov.info
            echo "File size: $(stat -f%z coverage/rust/lcov.info 2>/dev/null || stat -c%s coverage/rust/lcov.info 2>/dev/null) bytes"
          else
            echo "✗ ERROR: lcov.info not found at coverage/rust/lcov.info"
            echo "Current directory: $(pwd)"
            echo "Contents of coverage/rust/:"
            ls -la coverage/rust/ || echo "coverage/rust/ doesn't exist"
            echo "Searching for lcov files:"
            find . -name "*.lcov" -o -name "lcov.info" 2>/dev/null | head -10
            exit 1
          fi
      
      - name: Run Python coverage
        run: |
          mkdir -p coverage/python
          cd rustychickpeas-python
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install maturin pytest pytest-cov coverage[toml] pyarrow
          maturin develop --release
          # Run pytest with coverage, generating LCOV format
          pytest \
            --cov=rustychickpeas \
            --cov-report=term \
            --cov-report=lcov:../coverage/python/lcov.info \
            --cov-report=xml:../coverage/python/coverage.xml \
            --cov-report=html:../coverage/python/htmlcov \
            tests/ -v
          cd ..
          # Verify Python coverage file exists
          if [ -f coverage/python/lcov.info ]; then
            echo "✓ Created Python lcov.info at coverage/python/lcov.info"
            ls -lh coverage/python/lcov.info
            # Check if file has content (may be empty if no Python source files)
            if grep -q "^SF:" coverage/python/lcov.info 2>/dev/null; then
              echo "✓ Valid LCOV file with $(grep -c '^SF:' coverage/python/lcov.info) source files"
            else
              echo "⚠ Note: LCOV file exists but may be empty (expected for Rust extension modules)"
              echo "   This is normal - the Python module is compiled Rust code."
            fi
          else
            echo "⚠ WARNING: Python lcov.info not created (tests may have failed)"
          fi
      
      - name: Upload Rust coverage to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: coverage/rust/lcov.info
          flag-name: rust
          parallel: false
          # Optional: only needed for private repos
          # repo-token: ${{ secrets.COVERALLS_REPO_TOKEN }}
      
      - name: Run Python API coverage (Rust code executed by Python tests)
        run: |
          mkdir -p coverage/python-api
          cd rustychickpeas-python
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install maturin pytest pyarrow
          # Build in debug mode for coverage tracking
          maturin develop
          cd ..
          # Run tarpaulin on the Python API coverage test
          # This test runs pytest and tracks which Rust code is executed
          cargo tarpaulin \
            --package rustychickpeas-core \
            --test python_api_coverage_test \
            --follow-exec \
            --exclude-files '*/tests/*' \
            --exclude-files '*/benches/*' \
            --exclude-files '*/target/*' \
            --exclude-files '*/examples/*' \
            --exclude-files 'rustychickpeas-python/src/*' \
            --out Lcov \
            --root . \
            --timeout 600 \
            -- --ignored || true
          # Move lcov.info if it exists
          if [ -f lcov.info ]; then
            grep -E '^(SF:|TN:|FNF:|FNH:|FNDA:|DA:|LF:|LH:|BRDA:|BRF:|BRH:|end_of_record)' lcov.info > coverage/python-api/lcov.info || mv lcov.info coverage/python-api/lcov.info
            if [ -f coverage/python-api/lcov.info ]; then
              echo "✓ Created Python API coverage at coverage/python-api/lcov.info"
              if grep -q "^SF:" coverage/python-api/lcov.info 2>/dev/null; then
                echo "✓ Valid LCOV file with $(grep -c '^SF:' coverage/python-api/lcov.info) source files"
              fi
            fi
          else
            echo "⚠ Note: Python API coverage not generated (this is optional)"
          fi
      
      - name: Upload Python test coverage to Coveralls
        if: always()
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: coverage/python/lcov.info
          flag-name: python-tests
          parallel: false
          # Optional: only needed for private repos
          # repo-token: ${{ secrets.COVERALLS_REPO_TOKEN }}
      
      - name: Upload Python API coverage to Coveralls
        if: always()
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: coverage/python-api/lcov.info
          flag-name: python-api
          parallel: false
          # Optional: only needed for private repos
          # repo-token: ${{ secrets.COVERALLS_REPO_TOKEN }}

