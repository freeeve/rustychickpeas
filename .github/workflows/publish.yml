name: Publish to TestPyPI

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-and-publish:
    name: Build and publish wheels (${{ matrix.os }}, ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.10"
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.11"
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.12"
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.13"
          - os: ubuntu-latest
            arch: x86_64
            python-version: "3.14"
          # macOS x86_64 (Intel)
          - os: macos-latest
            arch: x86_64
            python-version: "3.10"
          - os: macos-latest
            arch: x86_64
            python-version: "3.11"
          - os: macos-latest
            arch: x86_64
            python-version: "3.12"
          - os: macos-latest
            arch: x86_64
            python-version: "3.13"
          - os: macos-latest
            arch: x86_64
            python-version: "3.14"
          # macOS arm64 (Apple Silicon)
          - os: macos-latest
            arch: arm64
            python-version: "3.10"
          - os: macos-latest
            arch: arm64
            python-version: "3.11"
          - os: macos-latest
            arch: arm64
            python-version: "3.12"
          - os: macos-latest
            arch: arm64
            python-version: "3.13"
          - os: macos-latest
            arch: arm64
            python-version: "3.14"
          # Windows x86_64
          - os: windows-latest
            arch: x86_64
            python-version: "3.10"
          - os: windows-latest
            arch: x86_64
            python-version: "3.11"
          - os: windows-latest
            arch: x86_64
            python-version: "3.12"
          - os: windows-latest
            arch: x86_64
            python-version: "3.13"
          - os: windows-latest
            arch: x86_64
            python-version: "3.14"
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: ${{ matrix.arch == 'arm64' && 'arm64' || 'x64' }}
      
      - name: Install maturin
        run: pip install maturin
      
      - name: Copy README for sdist
        run: |
          cp README.md rustychickpeas-python/README.md
      
      - name: Build wheels and sdist
        run: |
          cd rustychickpeas-python
          maturin build --release --out dist --sdist
        env:
          # For TestPyPI: native wheels are fine (less portable but work for testing)
          # For production PyPI, consider using manylinux Docker containers for better Linux compatibility
          MATURIN_PEP517_ARGS: "--manylinux=off"
          # PyO3 0.20.3 doesn't officially support Python 3.14 yet, use stable ABI
          PYO3_USE_ABI3_FORWARD_COMPATIBILITY: ${{ matrix.python-version == '3.14' && '1' || '' }}
      
      - name: Generate SHA256 hashes
        run: |
          cd rustychickpeas-python/dist
          if [ "${{ runner.os }}" == "Windows" ]; then
            powershell -Command "Get-ChildItem *.whl,*.tar.gz | ForEach-Object { $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash; Write-Output \"$($_.Name) SHA256=$hash\" }"
          else
            for file in *.whl *.tar.gz; do
              if [ -f "$file" ]; then
                hash=$(sha256sum "$file" | cut -d' ' -f1)
                echo "$file SHA256=$hash"
              fi
            done
          fi
      
      - name: Upload wheels and sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-py${{ matrix.python-version }}
          path: rustychickpeas-python/dist/*
          if-no-files-found: error
  
  publish:
    name: Publish to TestPyPI
    needs: build-and-publish
    runs-on: ubuntu-latest
    # Allow both releases and manual workflow dispatch for testing
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    environment:
      name: testpypi
      url: https://test.pypi.org/p/rustychickpeas
    # Required for PyPI Trusted Publishing (OIDC)
    permissions:
      id-token: write  # Required for OIDC token requests
      contents: read   # Required to checkout code
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install audit tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit cyclonedx-py
      
      - name: Download all wheels and sdist
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      
      - name: Generate SBOM (CycloneDX)
        run: |
          cd dist
          # Generate SBOM for the source distribution
          cyclonedx-py -o sbom.json -i rustychickpeas-*.tar.gz || echo "SBOM generation skipped (cyclonedx-py may not support source dists directly)"
          # Alternative: generate from installed package
          pip install dist/*.whl 2>/dev/null || true
          cyclonedx-py -o sbom.json || echo "SBOM generation completed"
          cat sbom.json || echo "SBOM file not found"
      
      - name: Run vulnerability scan (pip-audit)
        run: |
          cd dist
          # Install the package temporarily for audit
          pip install --force-reinstall *.whl 2>/dev/null || pip install *.tar.gz
          pip-audit --format=json --output=pip-audit.json || pip-audit --output=pip-audit.txt
          cat pip-audit.json 2>/dev/null || cat pip-audit.txt || echo "Audit completed"
      
      - name: Print file hashes
        run: |
          cd dist
          echo "## Package Hashes (SHA256)"
          echo ""
          if [ "${{ runner.os }}" == "Windows" ]; then
            powershell -Command "Get-ChildItem *.whl,*.tar.gz | ForEach-Object { $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash; Write-Output \"\`$($_.Name) = $hash\" }"
          else
            for file in *.whl *.tar.gz; do
              if [ -f "$file" ]; then
                hash=$(sha256sum "$file" | cut -d' ' -f1)
                echo "$file = $hash"
              fi
            done
          fi
      
      - name: Get version from pyproject.toml
        id: get_version
        run: |
          version=$(grep -E '^version = ' rustychickpeas-python/pyproject.toml | sed 's/version = "\(.*\)"/\1/' | head -1)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Package version: $version"
      
      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          # Option 1: Trusted Publishing (recommended - see cursor_md/PYPI_TRUSTED_PUBLISHER.md)
          # Uncomment after setting up PyPI Trusted Publisher:
          # trusted-publishing: true
          
          # Option 2: API Token (fallback - works immediately)
          password: ${{ secrets.TESTPYPI_API_TOKEN }}
          
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true
          print-hash: true 
      
      - name: Summary
        run: |
          echo "## Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **License**: MIT OR Apache-2.0" >> $GITHUB_STEP_SUMMARY
          echo "- **CI Link**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Published" >> $GITHUB_STEP_SUMMARY
          ls -lh dist/*.whl dist/*.tar.gz 2>/dev/null || echo "Files listed above" >> $GITHUB_STEP_SUMMARY

